(()=>{"use strict";var e={136:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=c(n(541)),d=c(n(748)),l=i(n(721)),u=i(n(662)),f=c(n(876)),v=c(n(740)),h=browser.i18n.getMessage;browser.runtime.onInstalled.addListener((e=>s(void 0,void 0,void 0,(function*(){switch(e.reason){case"install":yield d.default.setAll(),k();break;case"update":yield d.default.update()}}))));const p=(e="host")=>({title:h("notificationConnectionFailedTitle"),message:h("notificationConnectionFailedMessage",e),type:"basic",iconUrl:"icons/icons8-warn-120.png"});let y,g;function w(e){return s(this,void 0,void 0,(function*(){const{enableNotifications:t,enableNotificationsOnlyErrors:n}=yield d.default.getAll();if(t&&(!n||e.title===h("notificationConnectionFailedTitle")))return y&&browser.notifications.clear(y),y=yield browser.notifications.create(e),y}))}const{chrome:b}=window;let _,m=!1,x=new AbortController,C=[];function S(e){for(const t of C){if(new URL(e.url).host===t)return;if(e.documentUrl&&new URL(e.documentUrl).host===t)return}return _}function A(...e){a.default.error("Proxy error!",e),w(p(null==_?void 0:_.host)),P()}function L(e,t){return s(this,void 0,void 0,(function*(){if(!m){if(a.default.info("Connecting..."),_={type:"socks",host:e,port:u.SOCKS_PORT,proxyDNS:yield d.default.get("proxyDns")},m=!0,!t.mullvad_exit_ip)return a.default.error("Not connected via Mullvad!"),w({title:h("notificationConnectionFailedTitle"),message:h("notificationConnectionFailedMessageNonMullvad"),type:"basic",iconUrl:"icons/icons8-warn-120.png"}),void(yield P());g?(a.default.info("Proxy registered",_),b.proxy.onProxyError.addListener(A),b.proxy.settings.set({scope:"regular",value:{mode:"fixed_servers",rules:{singleProxy:{scheme:"socks5",host:_.host,port:parseInt(_.port)}}}})):(a.default.info("Proxy registered",_),browser.proxy.onError.addListener(A),browser.proxy.onRequest.addListener(S,{urls:["<all_urls>"]}));try{const e=yield u.fetchIpAddress(u.EndpointVariant.IPv4,{signal:x.signal});a.default.info(`IP address: ${e}`),w(((e="host")=>({title:h("notificationConnectionSucceededTitle"),message:h("notificationConnectionSucceededMessage",e),type:"basic",iconUrl:"icons/icons8-ok-120.png"}))(_.host)),browser.browserAction.setIcon({path:{16:"icons/locked-16.png",24:"icons/locked-24.png",32:"icons/locked-32.png"}}),m=!1}catch(t){(null==_?void 0:_.host)===e&&(a.default.error("Proxy request failed!"),w(p(_.host)),yield P())}}}))}function P(e=!1){return s(this,void 0,void 0,(function*(){e&&w(((e="host")=>({title:h("notificationConnectionDisconnectedTitle"),message:h("notificationConnectionDisconnectedMessage",e),type:"basic",iconUrl:"icons/icons8-cancel-120.png"}))(null==_?void 0:_.host)),browser.browserAction.setIcon({path:{16:"icons/unlocked-16.png",24:"icons/unlocked-24.png",32:"icons/unlocked-32.png"}}),browser.browserAction.setBadgeText({text:null}),g?yield new Promise((e=>{b.proxy.onProxyError.removeListener(A),b.proxy.settings.clear({scope:"regular"},e)})):(browser.proxy.onError.removeListener(A),browser.proxy.onRequest.removeListener(S)),_=null,m=!1,x.abort(),x=new AbortController}))}function E(e){var t;_&&!m&&browser.browserAction.setBadgeText({text:null!==(t=null==e?void 0:e.toUpperCase())&&void 0!==t?t:""})}d.default.addEventListener("changed",(e=>s(void 0,void 0,void 0,(function*(){if(e.detail.includes("enableExcludeList")||e.detail.includes("excludeList")){const e=yield d.default.getAll();if(e.enableExcludeList)return void(C=e.excludeList);C=[]}})))),v.default.onConnect.addListener((e=>{if("background"!==e.name)return;let t=!0;function n(){t&&e.postMessage({subject:"popup:/update",data:{isConnected:!!_&&!m,isConnecting:m,host:null==_?void 0:_.host}})}e.onDisconnect.addListener((()=>{t=!1})),e.onMessage.addListener((o=>s(void 0,void 0,void 0,(function*(){var r;switch(o.subject){case"background:/connect":{const r=/(?:\d{1,3}\.){3}\d{1,3}/.test(o.data.proxyHost)?o.data.proxyHost:u.getFullSocksHost(o.data.proxyHost);t&&e.postMessage({subject:"popup:/update",data:{isConnected:!1,isConnecting:!0}}),yield L(r,o.data.details),n();break}case"background:/disconnect":yield P(!0),n();break;case"background:/updateConnectionDetails":E(null===(r=o.data.details.mullvad_exit_ip_hostname)||void 0===r?void 0:r.slice(0,2))}})))),n()}));let O=!1;function k(){var e;return s(this,void 0,void 0,(function*(){if(O)return;const t=yield d.default.getAll();if(t){switch(O=!0,t.enableExcludeList&&(C=t.excludeList),yield l.getBrowserType()){case l.BrowserType.Chromium:g=!0,yield P();break;case l.BrowserType.Firefox:browser.browserAction.setBadgeBackgroundColor({color:"#294d73"})}if(t.autoConnect){const n=yield u.fetchConnectionDetails();if(t.rememberConnectedServer){const{recentServers:e}=yield f.default.get("recentServers");if(null==e?void 0:e.length){const t=e[0];yield L(u.getFullSocksHost(t.socks_name),n),E(t.country_code)}else a.default.error("Could not find last connected server.")}else{let t=u.SOCKS_ADDRESS;"wireguard"===n.mullvad_server_type&&(t=u.SOCKS_ADDRESS_WG),yield L(t,n),E(null===(e=n.mullvad_exit_ip_hostname)||void 0===e?void 0:e.slice(0,2))}}}}))}k()},970:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={autoConnect:!1,rememberConnectedServer:!1,proxyDns:!0,enableNotifications:!0,enableIpv6Lookups:!1,enableNotificationsOnlyErrors:!1,enableDebugInfo:!1,enableExcludeList:!1,excludeList:[]}},922:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.onConnect={addListener(e){browser.runtime.onConnect.addListener(e)},removeListener(e){browser.runtime.onConnect.removeListener(e)},hasListener:e=>browser.runtime.onConnect.hasListener(e)}}connect(e){return browser.runtime.connect(e)}connectTab(e,t){return browser.tabs.connect(e,t)}}},627:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventTarget=void 0;class n extends EventTarget{addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}dispatchEvent(e){return super.dispatchEvent(e)}}t.TypedEventTarget=n},850:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TypedStorageArea=void 0,t.TypedStorageArea=class{constructor(e){this.storageArea=e}get(e){return n(this,void 0,void 0,(function*(){return yield this.storageArea.get(e)}))}getBytesInUse(e){return n(this,void 0,void 0,(function*(){return yield this.storageArea.getBytesInUse(e)}))}set(e){return n(this,void 0,void 0,(function*(){yield this.storageArea.set(e)}))}remove(e){return n(this,void 0,void 0,(function*(){yield this.storageArea.remove(e)}))}clear(){return n(this,void 0,void 0,(function*(){yield this.storageArea.clear()}))}}},541:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;class n{constructor(e){this.prefix=e}log(e,t){const n=`${this.prefix} (Log): ${e}`;t?console.log(n,t):console.log(n)}info(e,t){const n=`${this.prefix} (Info): ${e}`;t?console.info(n,t):console.info(n)}error(e,t){const n=`${this.prefix} (Error): ${e}`;return t?console.error(n,t):console.error(n),new Error(n)}}t.Logger=n,t.default=new n("mullvad")},662:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getServerIdFromHost=t.fetchServerList=t.fetchPortDetails=t.fetchConnectionDetails=t.fetchIpAddress=t.CHECK_URL=t.getShortSocksName=t.getFullSocksHost=t.SOCKS_PORT=t.SOCKS_ADDRESS_WG=t.SOCKS_ADDRESS=t.EndpointVariant=void 0;const r=new(n(541).Logger)("mullvadApi"),i="am.i.mullvad.net",s=`https://${i}`,c=`https://ipv4.${i}`,a=`https://ipv6.${i}`;var d;function l(e){let t;switch(e){case d.IPv4:t=c;break;case d.IPv6:t=a;break;default:throw new Error("Invalid endpoint variant")}return{endpointAimIp:`${t}/ip`,endpointAimDetails:`${t}/json`}}!function(e){e[e.IPv4=0]="IPv4",e[e.IPv6=1]="IPv6"}(d=t.EndpointVariant||(t.EndpointVariant={}));const u=`${s}/port`;t.SOCKS_ADDRESS="10.8.0.1",t.SOCKS_ADDRESS_WG="10.64.0.1",t.SOCKS_PORT="1080",t.getFullSocksHost=function(e){return e.endsWith("mullvad.net")?e:`${e}.mullvad.net`},t.getShortSocksName=function(e){return e.endsWith(".socks5.relays.mullvad.net")?e.slice(0,-26):e},t.CHECK_URL="https://mullvad.net/check",t.fetchIpAddress=function(e=d.IPv4,t){return o(this,void 0,void 0,(function*(){r.info("Fetching IP address...");const{endpointAimIp:n}=l(e),o=yield fetch(n,t);return(yield o.text()).trim()}))},t.fetchConnectionDetails=function(e=d.IPv4,t){var n;return o(this,void 0,void 0,(function*(){r.info("Fetching connection details...");const{endpointAimDetails:o}=l(e),i=yield fetch(o,t),s=yield i.json();return s.mullvad_server_type=null===(n=s.mullvad_server_type)||void 0===n?void 0:n.toLowerCase(),s}))},t.fetchPortDetails=function(e,t){return o(this,void 0,void 0,(function*(){if(e<1||e>65536)throw new Error("Invalid port!");let n;r.info("Fetching port details...");try{const o=yield fetch(`${u}/${e}`,t);n=yield o.json()}catch(e){throw r.error("Failed to fetch port details",e)}return n}))},t.fetchServerList=function(e){return o(this,void 0,void 0,(function*(){let t;r.info("Fetching server list...");try{const n=yield fetch("https://api.mullvad.net/www/relays/wireguard/",e);t=yield n.json()}catch(e){throw r.error("Failed to fetch server list",e)}return t}))},t.getServerIdFromHost=function(e){return parseInt(e.slice(2,e.indexOf("-")))}},748:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(970)),s=r(n(541)),c=n(627),a=new(n(850).TypedStorageArea)(browser.storage.sync);t.default=new class extends c.TypedEventTarget{constructor(){super(),this.onStorageChanged=this.onStorageChanged.bind(this),browser.storage.onChanged.addListener(this.onStorageChanged),window.addEventListener("unload",(()=>{browser.storage.onChanged.removeListener(this.onStorageChanged)}))}onStorageChanged(e,t){if("sync"===t&&"options"in e){const{oldValue:t,newValue:n}=e.options,o=[];for(const e of Object.keys(n)){if(t){if(!(e in t))continue;const o=t[e],r=n[e];if(o===r)continue;if(o instanceof Array&&r instanceof Array&&o.length===r.length&&o.every(((e,t)=>e===r[t])))continue}o.push(e)}this.dispatchEvent(new CustomEvent("changed",{detail:o}))}}getAll(){return o(this,void 0,void 0,(function*(){const{options:e}=yield a.get("options");return e}))}setAll(e=i.default){return o(this,void 0,void 0,(function*(){return a.set({options:e})}))}get(e){return o(this,void 0,void 0,(function*(){const t=yield this.getAll();if(t.hasOwnProperty(e))return t[e];throw s.default.error(`Failed to find option ${e} in storage.`)}))}set(e,t){return o(this,void 0,void 0,(function*(){const n=yield this.getAll();return n[e]=t,this.setAll(n)}))}update(e=i.default){return o(this,void 0,void 0,(function*(){const t=yield this.getAll();t||this.setAll();for(const[n,o]of Object.entries(e))t.hasOwnProperty(n)||(t[n]=o);return this.setAll(t)}))}}},721:function(e,t){var n,o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getMinutesInMs=t.getBrowserType=t.BrowserType=void 0,function(e){e[e.Chromium=0]="Chromium",e[e.Firefox=1]="Firefox",e[e.Unknown=2]="Unknown"}(n=t.BrowserType||(t.BrowserType={})),t.getBrowserType=function(){return o(this,void 0,void 0,(function*(){const e=browser.runtime.getBrowserInfo;return e?"firefox"===(yield e()).name.toLowerCase()?n.Firefox:n.Unknown:n.Chromium}))},t.getMinutesInMs=function(e){return 60*e*1e3}},876:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=n(850);t.default=new o.TypedStorageArea(browser.storage.local)},740:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(922));t.default=new r.default}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(136)})();